// 3234. Count the Number of Substrings With Dominant Ones
// https://leetcode.com/problems/count-the-number-of-substrings-with-dominant-ones/

struct Solution;

impl Solution {
    pub fn number_of_substrings(s: String) -> i32 {
        let n = s.len();
        let bytes = s.as_bytes();
        let mut count = 0;

        // Collect positions of all zeros
        let zero_positions: Vec<usize> = (0..n).filter(|&i| bytes[i] == b'0').collect();

        let num_zeros = zero_positions.len();
        let max_zeros = ((n as f64).sqrt() as usize) + 1;

        // For each starting position
        for start in 0..n {
            // Find first zero at or after start
            let first_zero_idx = zero_positions.binary_search(&start).unwrap_or_else(|x| x);

            // Case 1: Substrings with 0 zeros (all ones from start)
            let next_zero_pos = if first_zero_idx < num_zeros {
                zero_positions[first_zero_idx]
            } else {
                n
            };
            // All substrings from start to any position before next zero are valid
            count += (next_zero_pos - start) as i32;

            // Case 2: Substrings with k zeros (k >= 1)
            for k in 1..=max_zeros.min(num_zeros - first_zero_idx) {
                let zero_idx = first_zero_idx + k - 1;
                if zero_idx >= num_zeros {
                    break;
                }

                let kth_zero_pos = zero_positions[zero_idx];
                if kth_zero_pos < start {
                    continue;
                }

                // We need at least k^2 ones
                let min_ones_needed = k * k;

                // Minimum length substring: from start to kth zero
                let min_length = kth_zero_pos - start + 1;
                let ones_so_far = min_length - k;

                if ones_so_far < min_ones_needed {
                    // Need more ones, find where we get enough
                    let ones_needed = min_ones_needed - ones_so_far;
                    let min_end = kth_zero_pos + ones_needed;

                    if min_end >= n {
                        continue;
                    }

                    // Find the next zero after kth zero
                    let next_zero_pos = if zero_idx + 1 < num_zeros {
                        zero_positions[zero_idx + 1]
                    } else {
                        n
                    };

                    // Count valid endings from min_end to just before next zero
                    if min_end < next_zero_pos {
                        count += (next_zero_pos - min_end) as i32;
                    }
                } else {
                    // Already have enough ones at kth zero position
                    let next_zero_pos = if zero_idx + 1 < num_zeros {
                        zero_positions[zero_idx + 1]
                    } else {
                        n
                    };

                    // All positions from kth_zero to just before next zero are valid
                    count += (next_zero_pos - kth_zero_pos) as i32;
                }
            }
        }

        count
    }
}

#[cfg(test)]
mod tests {
    use crate::medium::count_the_number_of_substrings_with_dominant_ones::Solution;

    #[test]
    fn test_number_of_substrings_1() {
        let s = "00011".to_string();
        assert_eq!(5, Solution::number_of_substrings(s));
    }

    #[test]
    fn test_number_of_substrings_2() {
        let s = "101101".to_string();
        assert_eq!(16, Solution::number_of_substrings(s));
    }

    #[test]
    fn test_number_of_substrings_3() {
        let s = "111101100001100001010010001110111001000110110011001010110001111110101101111011101000110010110000001111101000011000101111110100010101001110110111000010101101100010000111101000010001110011010100101010101000111110101100100010010111010101000111011010100000100011010101110010110011011000110010101100100001101110110101001110101000011110101011111000110100010011011110010001011000101111011111000001100101001100001000110110110101110001000001110000001100001100000101101010011010101110101000111010000010000001000101101101010001110100111101000011000110111101111111000001000101110100000011100111110111111100001100100110101000100000111101101010001000101110110010011111001000110000111001110001001111000010000011001100011010001000010100000011001100010010010111101011110110101110011111000111000011011100011110000111001001110110111100001000100110010000110010010001001100010110111110110000011111011110000010010011011100110111001010011011111010000001100011000001010010010101011101001010110101010101100101000010111111010111011111101100100111110000101111001011100001011110011111101010110110101100010111001100010110110010010001010011001111111110101010110001001100110110000101010010011100010101001111000111010110000111011110101110100101100101110010011101000101110011101010101110101011100001000011110111000000111101000001000100111000001110111100101111001010001010011100010111101100010001011111100101010010000100110001110011110000010101110111111101111111001011110000011100010101011101010110101001000010001110111110011100011100111100011001110001110011110010000010000111100101001010110010011100100101100010100010111100111010110110110100100010100101010101100110011001000111110101011010000001000101111011010100000101010100110101001001000100010001001100101011011011111111100010000010111101011011011101110101111011001110110110011111100111011110011100011101101111010000100111000001100111110101111011101011011000011001010111110100100110010110111111111110000100011010001010010001000100010001101100000101000010111111010010111110001111011101101011001000100010101010110011011101011011011111011011000100011011110111001000011000010011011011001001010000000100110110000111110111001010101011101010100110111000011101111001000000001000110110110101100110010111001011111010111100001001111011010010010101001010110010000010011000000000101110111101001110010111010101000011110111000110100010000111101111101101011101111011011101001010011111011111110110110000011110000011111011011100111110111011100001110111010010111010100010110010001010001111101001010100111101001010110010000011100100111110110001100010110000000101010111111011010001010100110110001110001010111100001001110000010010010110111011110011111100010100000011111100110110100110110101010100111101000000111110001111110010010001111010011101000010001000001010110000111111001101111111110101011001110110000011010011010011000011101010101101111111111000111010100010011010100011110011100011011100011111011101000011010001001101111110110001111100100111011110010100110010110000001101001011000100001000000101000101110011110010001100001101011101110010111001011001111100011100111010100100011100100001001001100111001010100011100010001001001101110110101001100111010010011010100110011110110001100110101011111101011011111101100101000110101100111011111000011111010101001111100101010001000000000001011100011111100100001100110101000000001010110010011011001011110111101011000001101001010001010011000100011011100101100100000111100101111011110010010111101001001011100000010111001011110000101000001000010000101011100111111101111101100000001111001111111011011001110011011101111111111100111101000010011110100110010100111111101110000100011110111011100110010110001".to_string();
        assert_eq!(13349, Solution::number_of_substrings(s));
    }
}
